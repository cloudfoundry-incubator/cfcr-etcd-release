#!/bin/bash -exu

source /var/vcap/packages/golang-1.13-linux/bosh/compile.env

export PATH="${PATH}:${GOPATH}/bin:${GOROOT}/bin"

LOG_DIR="/var/vcap/sys/log/acceptance-tests"

mkdir -p "${LOG_DIR}"
chown vcap:vcap "${LOG_DIR}"

pushd "/var/vcap/packages/acceptance/src/acceptance$" > /dev/null
  go install ./vendor/github.com/onsi/ginkgo/ginkgo

  CONFIG_FILE="/var/vcap/jobs/acceptance-tests/config/integration_config.json" \
    ginkgo -v --race . \
    1> >(tee -a "${LOG_DIR}/acceptance-tests.stdout.log") \
    2> >(tee -a "${LOG_DIR}/acceptance-tests.stderr.log")
popd > /dev/null
